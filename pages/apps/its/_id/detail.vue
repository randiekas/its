<template>
    <div class="grey lighten-4 fill-height mb-16">
		<div class="primary pb-16">
			<v-container>
				<Head
					title="Mulai"
					:subtitle="detail.latihan.nama">
                    <div>
                        <v-btn
                            exact
                            small
                            class="white"
                            :to="`/apps/its/${id}`">
                            <v-icon left>
                                mdi-chevron-left
                            </v-icon>
                            Kembali
                        </v-btn>
                    </div>
				</Head>
				<v-row class="mt-2">

				</v-row>
			</v-container>
		</div>
		<v-container class="mt-n16">
            <v-row
                v-if="detail.latihan.id!=undefined && soal.id!=undefined">
                <v-col md="8">
                    <v-card outlined>
                        <v-card-title>
                            Soal
                            <v-spacer/>
                            {{ke+1}}/{{ detail.latihan.soal.length }}
                        </v-card-title>
                        <v-divider/>
                        <v-card-text>
                            <div
                                class="mb-4"
                                v-html="soal.soal"/>

                            <div
                                v-for="(item, index) in soal.opsi"
                                :key="index">
                                <v-text-field
                                    persistent-placeholder
                                    outlined
                                    dense
                                    v-model="item.jawabanSiswa"
                                    :prefix="`${item.label} = `"
                                    :success="item.status==1"
                                    :error="item.status==0"
                                    :append-icon="ikonStatus[item.status]">
                                    <template v-slot:append-outer>
                                        <v-btn
                                            @click="checkJawaban"
                                            :disabled="sub!=index"
                                            class="primary">Check ({{ item.percobaan }})</v-btn>
                                    </template>
                                </v-text-field>
                            </div>
                        </v-card-text>
                        <v-card-actions>
                            <v-spacer/>
                            <v-btn
                                v-if="(ke+1)==detail.latihan.soal.length"
                                :disabled="soal.opsi.filter((item)=>item.status==1).length!=soal.opsi.length && soal.maksimal_percobaan>0"
                                @click="handelSelesai"
                                class="primary">Selesai</v-btn>
                            <template
                                v-else>
                                <v-btn
                                    class="primary">Ulangi</v-btn>
                                <v-btn
                                    :disabled="soal.opsi.filter((item)=>item.status==1).length!=soal.opsi.length && soal.maksimal_percobaan>0"
                                    @click="handelSoalSelanjutnya"
                                    class="primary">Soal Selanjutnya</v-btn>
                            </template>
                        </v-card-actions>
                    </v-card>
                </v-col>
                <v-col md="4">
                    <v-card outlined>
                        <v-card-subtitle>Feedback</v-card-subtitle>
                        <v-divider/>
                        <v-card-text>
                            <p
                                v-for="(item, index) in soal.opsi.filter((item)=>item.status==0)"
                                :key="index"
                                v-html="item.feedback"></p>
                        </v-card-text>
                        <v-divider/>
                        <v-tabs
                            v-model="tab"
                            centered
                            fixed-tabs>
                            <v-tab>Hints</v-tab>
                            <!-- <v-tab>Chat Bot</v-tab> -->
                        </v-tabs>
                        <v-card-text>
                            <v-tabs-items v-model="tab">
                                <v-tab-item>
                                    <v-btn
                                        v-if="hint===false"
                                        @click="hint=true"
                                        block>Lihat Hints</v-btn>
                                    <div
                                        v-if="hint"
                                        v-html="soal.hint">
                                    </div>
                                </v-tab-item>
                                <v-tab-item>
                                    Belum Tersedia
                                </v-tab-item>
                            </v-tabs-items>
                        </v-card-text>
                    </v-card>
                </v-col>
            </v-row>

            <v-card
                v-else>
                <v-skeleton-loader
                    class="mx-auto"
                    type="article, table-heading"/>
            </v-card>
		</v-container>
	</div>
</template>
<script>
export default {
    layout:'apps',
	props: [ 'setConfirmation', 'setSnackbar', 'setFetching', 'access' ],
    asyncData: async function({ route }){
        return {
            id: route.params.id,
            path_latihan_id:route.query.path_latihan_id,
        }
    },
    data: function(){
        return {
            isFetching:true,
            detail: {
                latihan:{nama: '-'}
            },
            soal: {},
            sub: 0,
            tab:0,
            ke:0,
            hint: false,
            ikonStatus: {
                0: 'mdi-close-circle',
                1: 'mdi-check-decagram',
                'undefined': '',
            }
        }
    },
    mounted: function(){
        this.handelLoadData()
    },
    methods: {
        handelLoadData: async function(){

            this.isFetching	= true
			let detail      = (await this.$api.$get(`/path/saya/${this.id}/latihan/${this.path_latihan_id}`)).data
            detail.latihan.soal     = detail.latihan.soal.map((item)=>{
                                    item.opsi               = JSON.parse(item.opsi).map((row)=>{
                                        return {
                                            ...row,
                                            percobaan: item.maksimal_percobaan
                                        }
                                    })
                                    item.percobaan          = []
                                    item.jumlah_percobaan   = 0
                                    item.status             = 0
                                    return item
                                })
            // detail.latihan.opsi     = JSON.parse(detail.latihan.opsi)
            if(detail.latihan.soal.length>0){
                this.soal   = detail.latihan.soal[this.ke]
                this.sub            = 0
            }
            this.detail     = detail
			this.isFetching	= false

        },

        checkJawaban: function(){
            
            this.soal.opsi[this.sub].percobaan  -= 1
            this.soal.opsi[this.sub].status     = this.soal.opsi[this.sub].jawaban == this.soal.opsi[this.sub].jawabanSiswa ? 1 : 0
            // console.log(this.soal.opsi[this.sub])
            
            // this.soal.opsi                  = this.soal.opsi.map((item)=>{
            //     item                        = Object.assign({}, item)
            //     item.status                 = item.jawaban == item.jawabanSiswa ? 1 : 0
            //     return item
            // })

            if(this.soal.opsi[this.sub].percobaan==0 || this.soal.opsi[this.sub].status){
                this.sub                    += 1
            }

            this.soal.opsi                  = Object.assign([], this.soal.opsi)
            // this.soal.status                = this.soal.opsi.filter((item)=>item.status==1).length==this.soal.opsi.length?1:0
            // this.soal.jumlah_percobaan      += 1
            // this.soal.percobaan.push(Object.assign({}, this.soal.opsi))
        },

        handelSoalSelanjutnya: function(){
            this.hint           = false
            this.ke             = this.ke+1
            this.soal           = this.detail.latihan.soal[this.ke]
            this.sub            = 0
            // this.sub_percobaan  = this.soal.maksimal_percobaan
        },

        handelSelesai: async function(){
            this.setFetching(true)
            const payload   = {
                detail: this.detail.latihan.soal.map((item)=>{
                    return {
                        latihan_detail_id: item.id,
                        jumlah_percobaan:item.jumlah_percobaan,
                        percobaan:JSON.stringify(item.percobaan),
                        status:item.status,
                    }
                })
            }

            this.$api.$post(`path/saya/${this.id}/latihan/${this.path_latihan_id}`, payload).then((resp)=>{
                this.setFetching(false)
                this.setConfirmation({
                    status: true,
                    title: 'Berhasil',
                    message: 'Jawaban latihan berhasil disimpan, terimakasih sudah mengikuti latihan :-D',
                    handelOk: ()=> this.setConfirmation({ status: false })
                })
                this.$router.push(`/apps/its/${this.id}`)
            })
        }
    }
}
</script>
